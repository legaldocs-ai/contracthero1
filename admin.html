<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>Aurum Admin — Internal Desk</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text",
          system-ui, "Segoe UI", sans-serif;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: radial-gradient(
          circle at top,
          #020617 0%,
          #020617 45%,
          #000 100%
        );
        color: #e5e7eb;
      }
      .shell {
        width: 100%;
        max-width: 1200px;
        margin: 32px auto;
        border-radius: 28px;
        background: radial-gradient(
          circle at top left,
          #020617 0%,
          #020617 40%,
          #020617 55%,
          #020617 100%
        );
        box-shadow: 0 28px 80px rgba(0, 0, 0, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.14);
        overflow: hidden;
        position: relative;
      }
      .shell::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: radial-gradient(
          circle at 0% 0%,
          rgba(248, 250, 252, 0.18),
          transparent 55%
        );
        mix-blend-mode: soft-light;
        opacity: 0.65;
      }
      .shell-inner {
        position: relative;
        padding: 24px 26px 24px;
        z-index: 1;
      }

      .top-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 18px;
      }
      .top-left {
        display: flex;
        align-items: center;
        gap: 14px;
      }
      .logo-circle {
        width: 46px;
        height: 46px;
        border-radius: 18px;
        background: conic-gradient(
          from 210deg,
          #facc6b,
          #fef9c3,
          #facc6b,
          #b45309
        );
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.65);
      }
      .logo-circle span {
        font-weight: 800;
        font-size: 22px;
        color: #020617;
      }
      .top-title {
        display: flex;
        flex-direction: column;
        gap: 3px;
      }
      .top-title-main {
        font-size: 18px;
        font-weight: 600;
        letter-spacing: 0.02em;
      }
      .top-title-sub {
        font-size: 11px;
        color: #9ca3af;
      }
      .pill-row {
        display: flex;
        gap: 8px;
        margin-top: 6px;
      }
      .pill {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.14em;
        padding: 5px 10px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        color: #e5e7eb;
        background: rgba(15, 23, 42, 0.9);
      }
      .pill.gold {
        border-color: rgba(245, 208, 90, 0.75);
        color: #facc6b;
        background: rgba(30, 64, 175, 0.55);
      }
      .top-right {
        font-size: 10px;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        color: #6b7280;
      }

      /* Views */
      #login-view {
        margin-top: 12px;
      }
      #dashboard-view {
        margin-top: 12px;
        display: none;
      }

      /* Login card */
      .login-card {
        max-width: 420px;
        border-radius: 22px;
        background: radial-gradient(
          circle at top left,
          #020617 0%,
          #020617 55%,
          #020617 100%
        );
        border: 1px solid rgba(148, 163, 184, 0.55);
        box-shadow: 0 22px 60px rgba(0, 0, 0, 0.88);
        padding: 22px 26px 20px;
      }
      .login-title {
        font-size: 17px;
        font-weight: 600;
        margin-bottom: 6px;
      }
      .login-sub {
        font-size: 12px;
        color: #9ca3af;
        margin-bottom: 16px;
      }
      .field-label {
        font-size: 12px;
        color: #d1d5db;
        margin-bottom: 6px;
      }
      .field-input {
        width: 100%;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        padding: 9px 14px 9px;
        background: radial-gradient(circle at top, #020617, #020617);
        color: #f9fafb;
        font-size: 13px;
        outline: none;
      }
      .field-input:focus {
        border-color: #facc6b;
        box-shadow: 0 0 0 1px rgba(250, 204, 21, 0.45);
      }
      .btn-main {
        width: 100%;
        margin-top: 14px;
        border-radius: 999px;
        border: none;
        padding: 10px 16px;
        background: linear-gradient(135deg, #fbbf24, #f59e0b);
        color: #111827;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 14px 40px rgba(0, 0, 0, 0.75);
        transition: transform 0.1s ease, box-shadow 0.1s ease,
          filter 0.1s ease;
      }
      .btn-main:hover {
        filter: brightness(1.05);
        transform: translateY(-1px);
        box-shadow: 0 18px 48px rgba(0, 0, 0, 0.85);
      }
      .login-error {
        margin-top: 10px;
        font-size: 11px;
        color: #f97373;
      }
      .login-hint {
        margin-top: 14px;
        font-size: 11px;
        color: #9ca3af;
        line-height: 1.6;
        border-top: 1px dashed rgba(75, 85, 99, 0.8);
        padding-top: 10px;
      }
      .login-hint code {
        font-size: 11px;
        background: rgba(15, 23, 42, 0.9);
        padding: 1px 5px;
        border-radius: 5px;
        color: #e5e7eb;
      }

      /* Dashboard layout */
      .dash-layout {
        display: grid;
        grid-template-columns: 280px minmax(0, 1fr);
        gap: 18px;
      }

      .side-card {
        border-radius: 18px;
        background: radial-gradient(
          circle at top left,
          #020617 0%,
          #020617 50%,
          #020617 100%
        );
        border: 1px solid rgba(148, 163, 184, 0.4);
        padding: 12px 14px 12px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .side-section-title {
        font-size: 12px;
        color: #9ca3af;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        margin-bottom: 4px;
      }
      .side-block {
        border-radius: 14px;
        border: 1px solid rgba(55, 65, 81, 0.9);
        padding: 10px 10px 9px;
        background: radial-gradient(circle at top, #020617, #020617);
      }
      .side-kv {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        margin-bottom: 4px;
        color: #d1d5db;
      }
      .side-kv span:last-child {
        color: #f3f4f6;
        font-weight: 500;
      }
      .side-kv-muted {
        font-size: 11px;
        color: #9ca3af;
      }
      .side-btn {
        margin-top: 10px;
        width: 100%;
        border-radius: 999px;
        padding: 7px 12px;
        border: none;
        background: rgba(248, 250, 252, 0.05);
        color: #e5e7eb;
        font-size: 12px;
        cursor: pointer;
        border: 1px solid rgba(148, 163, 184, 0.4);
      }
      .side-btn:hover {
        background: rgba(248, 250, 252, 0.09);
      }

      .side-small-table {
        margin-top: 6px;
        max-height: 192px;
        overflow: hidden;
        font-size: 11px;
      }
      .side-small-header,
      .side-small-row {
        display: grid;
        grid-template-columns: 18px minmax(0, 1.5fr) auto;
        gap: 6px;
        padding: 2px 0;
      }
      .side-small-header {
        color: #9ca3af;
        border-bottom: 1px solid rgba(55, 65, 81, 0.9);
        margin-bottom: 4px;
      }
      .side-small-row {
        color: #e5e7eb;
      }
      .tag-plan {
        padding: 1px 6px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        font-size: 10px;
      }

      /* Main panel */
      .main-card {
        border-radius: 18px;
        border: 1px solid rgba(55, 65, 81, 0.9);
        background: radial-gradient(
          circle at top,
          #020617 0%,
          #020617 45%,
          #020617 100%
        );
        padding: 14px 14px 12px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .main-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 6px;
      }
      .main-tab {
        font-size: 11px;
        padding: 5px 10px;
        border-radius: 999px;
        border: 1px solid transparent;
        cursor: pointer;
        color: #9ca3af;
        background: transparent;
      }
      .main-tab.active {
        border-color: rgba(148, 163, 184, 0.8);
        background: rgba(15, 23, 42, 0.9);
        color: #f9fafb;
      }

      .main-top-row {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 8px;
      }
      .metric-card {
        border-radius: 14px;
        border: 1px solid rgba(55, 65, 81, 0.9);
        padding: 8px 10px 7px;
        background: radial-gradient(circle at top, #020617, #020617);
      }
      .metric-label {
        font-size: 11px;
        color: #9ca3af;
        margin-bottom: 4px;
      }
      .metric-value {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 2px;
      }
      .metric-hint {
        font-size: 10px;
        color: #9ca3af;
      }

      .chart-row {
        display: grid;
        grid-template-columns: 1.4fr 0.8fr;
        gap: 10px;
        margin-top: 8px;
      }
      .chart-card {
        border-radius: 14px;
        border: 1px solid rgba(55, 65, 81, 0.9);
        background: radial-gradient(circle at top, #020617, #020617);
        padding: 8px;
      }
      .chart-title {
        font-size: 11px;
        color: #9ca3af;
        margin-bottom: 4px;
      }
      canvas {
        width: 100%;
        height: 160px;
      }

      .table-section {
        margin-top: 10px;
        border-radius: 14px;
        border: 1px solid rgba(55, 65, 81, 0.9);
        background: radial-gradient(circle at top, #020617, #020617);
        padding: 9px 9px 8px;
      }
      .table-header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
      }
      .table-title {
        font-size: 12px;
        color: #e5e7eb;
      }
      .table-sub {
        font-size: 11px;
        color: #9ca3af;
      }
      .table-actions {
        display: flex;
        gap: 6px;
        align-items: center;
      }
      .search-input {
        border-radius: 999px;
        border: 1px solid rgba(75, 85, 99, 0.9);
        background: rgba(15, 23, 42, 0.9);
        padding: 4px 10px;
        font-size: 11px;
        color: #e5e7eb;
        min-width: 170px;
        outline: none;
      }
      .search-input::placeholder {
        color: #6b7280;
      }
      .btn-small {
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.7);
        background: rgba(15, 23, 42, 0.9);
        color: #e5e7eb;
        font-size: 11px;
        padding: 4px 9px;
        cursor: pointer;
      }
      .btn-small.gold {
        border-color: rgba(245, 208, 90, 0.85);
        color: #facc6b;
      }
      .btn-small:disabled {
        opacity: 0.4;
        cursor: default;
      }
      .table-scroll {
        margin-top: 6px;
        max-height: 230px;
        overflow: auto;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
      }
      thead {
        position: sticky;
        top: 0;
        background: rgba(15, 23, 42, 0.98);
        z-index: 1;
      }
      th,
      td {
        padding: 4px 6px;
        text-align: left;
        border-bottom: 1px solid rgba(31, 41, 55, 0.9);
        white-space: nowrap;
      }
      th {
        color: #9ca3af;
        font-weight: 500;
      }
      tbody tr:nth-child(2n) {
        background: rgba(15, 23, 42, 0.75);
      }
      .td-email {
        max-width: 220px;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .td-ip {
        max-width: 120px;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .tag-free {
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.8);
        padding: 1px 6px;
        font-size: 10px;
      }
      .tag-paid {
        border-radius: 999px;
        border: 1px solid rgba(52, 211, 153, 0.8);
        padding: 1px 6px;
        font-size: 10px;
        color: #bbf7d0;
      }
      .pagination-row {
        margin-top: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 11px;
        color: #9ca3af;
      }
      .pagination-controls {
        display: flex;
        gap: 6px;
        align-items: center;
      }
      .select-small {
        background: rgba(15, 23, 42, 0.9);
        border-radius: 999px;
        border: 1px solid rgba(75, 85, 99, 0.9);
        color: #e5e7eb;
        font-size: 11px;
        padding: 3px 7px;
      }

      @media (max-width: 960px) {
        .dash-layout {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <div class="shell-inner">
        <div class="top-bar">
          <div class="top-left">
            <div class="logo-circle">
              <span>A</span>
            </div>
            <div class="top-title">
              <div class="top-title-main">Aurum Task Desk 后台总览</div>
              <div class="top-title-sub">
                查看注册用户、套餐分布、访问日志，仅供内部使用。
              </div>
              <div class="pill-row">
                <div class="pill gold">AURUM ADMIN</div>
                <div class="pill">INTERNAL DESK</div>
              </div>
            </div>
          </div>
          <div class="top-right">INTERNAL USE ONLY</div>
        </div>

        <!-- 登录视图 -->
        <section id="login-view">
          <div class="login-card">
            <div class="login-title">Aurum Task Desk 后台</div>
            <div class="login-sub">
              输入你的管理员密码登录，然后查看注册用户、最近 7 天新增、套餐分布等基础数据。
            </div>

            <div>
              <div class="field-label">Admin password</div>
              <input
                id="admin-password-input"
                class="field-input"
                type="password"
                placeholder="管理员密码"
              />
            </div>

            <button id="login-btn" class="btn-main">
              进入 Aurum Task Desk 后台
            </button>

            <div id="login-error" class="login-error" style="display: none"></div>

            <div class="login-hint">
              提示：密码保存在 Cloudflare Worker 的
              <code>ADMIN_PASSWORD</code> 环境变量中。<br />
              本页面属于「自己看的后台」，不要对外公开 URL。
            </div>
          </div>
        </section>

        <!-- Dashboard 视图 -->
        <section id="dashboard-view">
          <div class="dash-layout">
            <!-- 左侧侧边栏 -->
            <aside class="side-card">
              <div>
                <div class="side-section-title">Environment</div>
                <div class="side-block" style="margin-bottom: 8px">
                  <div class="side-kv">
                    <span>Environment</span>
                    <span id="env-env">Production</span>
                  </div>
                  <div class="side-kv">
                    <span>Backend</span>
                    <span>Aurum Worker · D1 · AI</span>
                  </div>
                </div>
              </div>

              <div>
                <div class="side-section-title">Overview</div>
                <div class="side-block">
                  <div class="side-kv">
                    <span>总用户数</span>
                    <span id="side-total-users">-</span>
                  </div>
                  <div class="side-kv">
                    <span>最近一位用户注册时间</span>
                    <span id="side-latest-at">-</span>
                  </div>
                  <div class="side-kv">
                    <span>最近 7 天新增</span>
                    <span id="side-last7">-</span>
                  </div>
                  <div class="side-kv">
                    <span>付费 / 免费</span>
                    <span id="side-paid-free">0 / 0</span>
                  </div>
                  <div class="side-kv side-kv-muted" style="margin-top: 6px">
                    所有数据来自 D1 数据库 <code>aurum_users</code>，每次刷新都会重新统计。
                  </div>
                  <button id="logout-btn" class="side-btn">退出后台</button>
                </div>
              </div>

              <div>
                <div class="side-section-title">
                  最近 5 个注册用户（按注册时间倒序）
                </div>
                <div class="side-block">
                  <div class="side-small-table">
                    <div class="side-small-header">
                      <span>#</span>
                      <span>Email</span>
                      <span>Plan</span>
                    </div>
                    <div id="side-latest-users"></div>
                  </div>
                </div>
              </div>
            </aside>

            <!-- 右侧主内容 -->
            <main class="main-card">
              <div class="main-tabs">
                <button class="main-tab active" id="tab-users">
                  用户概览
                </button>
                <button class="main-tab" id="tab-visits" disabled>
                  访问日志（下个版本）
                </button>
              </div>

              <div id="panel-users">
                <!-- 顶部指标 -->
                <div class="main-top-row">
                  <div class="metric-card">
                    <div class="metric-label">总用户数</div>
                    <div class="metric-value" id="metric-total-users">-</div>
                    <div class="metric-hint" id="metric-first-at">
                      -
                    </div>
                  </div>
                  <div class="metric-card">
                    <div class="metric-label">最近 7 天新增</div>
                    <div class="metric-value" id="metric-last7">-</div>
                    <div class="metric-hint">
                      按注册时间分组，便于观察投放效果。
                    </div>
                  </div>
                  <div class="metric-card">
                    <div class="metric-label">套餐分布（当前用户）</div>
                    <div class="metric-value" id="metric-plan-breakdown">
                      free × 0
                    </div>
                    <div class="metric-hint">
                      后面你接入 Paddle / Stripe 之后，这里会区分付费 / 免费。
                    </div>
                  </div>
                </div>

                <!-- 图表 -->
                <div class="chart-row">
                  <div class="chart-card">
                    <div class="chart-title">最近 14 天注册趋势</div>
                    <canvas id="chart-registrations"></canvas>
                  </div>
                  <div class="chart-card">
                    <div class="chart-title">套餐分布（当前页数据）</div>
                    <canvas id="chart-plans"></canvas>
                  </div>
                </div>

                <!-- 用户表格 -->
                <div class="table-section">
                  <div class="table-header-row">
                    <div>
                      <div class="table-title">最近注册用户（支持搜索 + 分页）</div>
                      <div class="table-sub" id="table-subtitle">
                        按创建时间倒序，最多 200 条 / 页。
                      </div>
                    </div>
                    <div class="table-actions">
                      <input
                        id="search-input"
                        class="search-input"
                        placeholder="搜索 email / 国家 / 来源"
                      />
                      <button id="export-btn" class="btn-small gold">
                        导出 CSV
                      </button>
                    </div>
                  </div>

                  <div class="table-scroll">
                    <table>
                      <thead>
                        <tr>
                          <th style="width: 38px">ID</th>
                          <th>Email</th>
                          <th style="width: 70px">Plan</th>
                          <th style="width: 120px">IP</th>
                          <th style="width: 70px">国家</th>
                          <th style="width: 80px">来源</th>
                          <th style="width: 150px">创建时间</th>
                        </tr>
                      </thead>
                      <tbody id="users-tbody"></tbody>
                    </table>
                  </div>

                  <div class="pagination-row">
                    <div id="pagination-info">-</div>
                    <div class="pagination-controls">
                      <span>每页</span>
                      <select id="page-size-select" class="select-small">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50" selected>50</option>
                        <option value="100">100</option>
                      </select>
                      <button id="prev-page-btn" class="btn-small">
                        上一页
                      </button>
                      <button id="next-page-btn" class="btn-small">
                        下一页
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <div id="panel-visits" style="display: none">
                <!-- 以后加访问日志，这里先留空 -->
              </div>
            </main>
          </div>
        </section>
      </div>
    </div>

    <script>
      // 你的 Worker 域名
      const API_BASE = "https://aurum-task-worker.sophieinbg.workers.dev";

      let adminPassword = "";
      let page = 1;
      let pageSize = 50;
      let total = 0;
      let search = "";

      const loginView = document.getElementById("login-view");
      const dashView = document.getElementById("dashboard-view");
      const loginBtn = document.getElementById("login-btn");
      const logoutBtn = document.getElementById("logout-btn");
      const loginError = document.getElementById("login-error");
      const adminPwdInput = document.getElementById("admin-password-input");

      const usersTbody = document.getElementById("users-tbody");
      const paginationInfo = document.getElementById("pagination-info");
      const pageSizeSelect = document.getElementById("page-size-select");
      const prevBtn = document.getElementById("prev-page-btn");
      const nextBtn = document.getElementById("next-page-btn");
      const searchInput = document.getElementById("search-input");
      const exportBtn = document.getElementById("export-btn");

      const metricTotalUsers = document.getElementById("metric-total-users");
      const metricFirstAt = document.getElementById("metric-first-at");
      const metricLast7 = document.getElementById("metric-last7");
      const metricPlanBreakdown = document.getElementById(
        "metric-plan-breakdown"
      );

      const sideTotalUsers = document.getElementById("side-total-users");
      const sideLatestAt = document.getElementById("side-latest-at");
      const sideLast7 = document.getElementById("side-last7");
      const sidePaidFree = document.getElementById("side-paid-free");
      const sideLatestUsersWrap = document.getElementById("side-latest-users");

      const subTitle = document.getElementById("table-subtitle");

      const chartRegCanvas = document.getElementById("chart-registrations");
      const chartPlansCanvas = document.getElementById("chart-plans");

      function formatTs(ts) {
        if (!ts) return "-";
        const d = new Date(ts * 1000);
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        const hh = String(d.getHours()).padStart(2, "0");
        const mi = String(d.getMinutes()).padStart(2, "0");
        const ss = String(d.getSeconds()).padStart(2, "0");
        return `${yyyy}/${mm}/${dd} ${hh}:${mi}:${ss}`;
      }

      function debounce(fn, delay) {
        let t;
        return function (...args) {
          clearTimeout(t);
          t = setTimeout(() => fn.apply(this, args), delay);
        };
      }

      async function adminLogin() {
        const pwd = adminPwdInput.value.trim();
        if (!pwd) {
          loginError.style.display = "block";
          loginError.textContent = "请输入管理员密码";
          return;
        }
        loginError.style.display = "none";
        loginBtn.disabled = true;
        loginBtn.textContent = "登录中...";

        try {
          const resp = await fetch(`${API_BASE}/admin/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ password: pwd }),
          });

          const data = await resp.json().catch(() => ({}));
          if (!resp.ok || !data.ok) {
            throw new Error(data.error || "登录失败");
          }

          adminPassword = pwd;
          // 切到 dashboard
          loginView.style.display = "none";
          dashView.style.display = "block";

          page = 1;
          await loadUsers();
        } catch (err) {
          loginError.style.display = "block";
          loginError.textContent =
            err && err.message
              ? err.message
              : "网络异常，请检查 Worker 是否在线。";
        } finally {
          loginBtn.disabled = false;
          loginBtn.textContent = "进入 Aurum Task Desk 后台";
        }
      }

      async function loadUsers() {
        if (!adminPassword) return;

        const params = new URLSearchParams();
        params.set("page", String(page));
        params.set("pageSize", String(pageSize));
        if (search) params.set("search", search);

        const resp = await fetch(`${API_BASE}/admin/users?` + params, {
          headers: { "x-admin-password": adminPassword },
        });

        if (!resp.ok) {
          const data = await resp.json().catch(() => ({}));
          alert(
            "加载用户列表失败：" + (data.error || `HTTP ${resp.status}`)
          );
          return;
        }

        const data = await resp.json();
        if (!data.ok) {
          alert("加载用户列表失败：" + (data.error || "Unknown error"));
          return;
        }

        const users = data.users || [];
        total = data.total || 0;
        page = data.page || 1;
        pageSize = data.pageSize || pageSize;

        renderUsersTable(users);
        updatePagination(users);
        updateOverview(users);
        updateSideLatest(users);
        drawCharts(users);
      }

      function renderUsersTable(users) {
        usersTbody.innerHTML = "";
        if (!users.length) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 7;
          td.textContent = "暂无数据";
          td.style.textAlign = "center";
          td.style.padding = "10px 0";
          tr.appendChild(td);
          usersTbody.appendChild(tr);
          return;
        }

        for (const u of users) {
          const tr = document.createElement("tr");

          const tdId = document.createElement("td");
          tdId.textContent = u.id;
          tr.appendChild(tdId);

          const tdEmail = document.createElement("td");
          tdEmail.textContent = u.email || "-";
          tdEmail.className = "td-email";
          tr.appendChild(tdEmail);

          const tdPlan = document.createElement("td");
          const spanPlan = document.createElement("span");
          const plan = (u.plan || "free").toLowerCase();
          if (plan === "free") {
            spanPlan.className = "tag-free";
            spanPlan.textContent = "FREE";
          } else {
            spanPlan.className = "tag-paid";
            spanPlan.textContent = plan.toUpperCase();
          }
          tdPlan.appendChild(spanPlan);
          tr.appendChild(tdPlan);

          const tdIp = document.createElement("td");
          tdIp.textContent = u.ip || "-";
          tdIp.className = "td-ip";
          tr.appendChild(tdIp);

          const tdCountry = document.createElement("td");
          tdCountry.textContent = u.country || "-";
          tr.appendChild(tdCountry);

          const tdSource = document.createElement("td");
          tdSource.textContent = u.signup_source || "-";
          tr.appendChild(tdSource);

          const tdCreated = document.createElement("td");
          tdCreated.textContent = formatTs(u.created_at);
          tr.appendChild(tdCreated);

          usersTbody.appendChild(tr);
        }
      }

      function updatePagination(users) {
        const start = total === 0 ? 0 : (page - 1) * pageSize + 1;
        const end = Math.min(page * pageSize, total);
        paginationInfo.textContent =
          total === 0
            ? "暂无用户"
            : `第 ${start}–${end} 条，共 ${total} 条`;

        prevBtn.disabled = page <= 1;
        nextBtn.disabled = page * pageSize >= total;

        subTitle.textContent = `按创建时间倒序，当前第 ${page} 页，每页 ${pageSize} 条（总计 ${total} 条结果）。`;
      }

      function updateOverview(users) {
        metricTotalUsers.textContent = total;
        sideTotalUsers.textContent = total;

        if (users.length) {
          const latest = users[0];
          sideLatestAt.textContent = formatTs(latest.created_at);
        } else {
          sideLatestAt.textContent = "-";
        }

        // 总的第一位用户注册时间（当前只用“当前页最后一位”近似表示）
        if (users.length) {
          const last = users[users.length - 1];
          metricFirstAt.textContent =
            "最早一位用户注册时间（当前页）：" +
            formatTs(last.created_at);
        } else {
          metricFirstAt.textContent = "-";
        }

        const now = Date.now() / 1000;
        const sevenDaysAgo = now - 7 * 24 * 3600;
        let last7 = 0;
        let paid = 0;
        let free = 0;

        // 注意这里只能用「当前返回的 users」估算最近 7 天
        for (const u of users) {
          if (u.created_at >= sevenDaysAgo) last7++;
          const plan = (u.plan || "free").toLowerCase();
          if (plan === "free") free++;
          else paid++;
        }

        metricLast7.textContent = last7;
        sideLast7.textContent = last7;
        sidePaidFree.textContent = `${paid} / ${free}`;
        metricPlanBreakdown.textContent = `free × ${free}${
          paid ? `，paid × ${paid}` : ""
        }`;
      }

      function updateSideLatest(users) {
        sideLatestUsersWrap.innerHTML = "";
        const list = users.slice(0, 5);
        if (!list.length) {
          const div = document.createElement("div");
          div.style.fontSize = "11px";
          div.style.color = "#9ca3af";
          div.textContent = "暂无数据";
          sideLatestUsersWrap.appendChild(div);
          return;
        }

        list.forEach((u, idx) => {
          const row = document.createElement("div");
          row.className = "side-small-row";

          const c1 = document.createElement("div");
          c1.textContent = String(idx + 1);
          row.appendChild(c1);

          const c2 = document.createElement("div");
          c2.textContent = u.email || "-";
          row.appendChild(c2);

          const c3 = document.createElement("div");
          const span = document.createElement("span");
          span.className = "tag-plan";
          span.textContent = (u.plan || "free").toUpperCase();
          c3.appendChild(span);
          row.appendChild(c3);

          sideLatestUsersWrap.appendChild(row);
        });
      }

      function drawLine(ctx, points, color) {
        const w = ctx.canvas.width;
        const h = ctx.canvas.height;
        ctx.clearRect(0, 0, w, h);

        ctx.save();
        ctx.scale(devicePixelRatio, devicePixelRatio);

        ctx.fillStyle = "rgba(15,23,42,0.9)";
        ctx.fillRect(0, 0, w, h);

        if (!points.length) {
          ctx.fillStyle = "#6b7280";
          ctx.font = "11px -apple-system,system-ui,sans-serif";
          ctx.fillText("暂无数据", 8, h / 2);
          ctx.restore();
          return;
        }

        const maxY = Math.max(
          1,
          ...points.map((p) => p.value || 0)
        );

        const padding = 20;
        const innerW = w - padding * 2;
        const innerH = h - padding * 2;

        ctx.strokeStyle = "rgba(55,65,81,0.8)";
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(padding, h - padding);
        ctx.lineTo(w - padding, h - padding);
        ctx.stroke();

        ctx.beginPath();
        const len = points.length;
        points.forEach((p, idx) => {
          const x =
            padding + (innerW * idx) / (Math.max(1, len - 1));
          const y =
            h -
            padding -
            (innerH * (p.value || 0)) / maxY;
          if (idx === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.stroke();

        points.forEach((p, idx) => {
          const x =
            padding + (innerW * idx) / (Math.max(1, len - 1));
          const y =
            h -
            padding -
            (innerH * (p.value || 0)) / maxY;
          ctx.beginPath();
          ctx.arc(x, y, 2.5, 0, Math.PI * 2);
          ctx.fillStyle = color;
          ctx.fill();
        });

        ctx.restore();
      }

      function drawDonut(ctx, freeCount, paidCount) {
        const w = ctx.canvas.width;
        const h = ctx.canvas.height;
        ctx.clearRect(0, 0, w, h);
        ctx.save();
        ctx.scale(devicePixelRatio, devicePixelRatio);

        ctx.fillStyle = "rgba(15,23,42,0.9)";
        ctx.fillRect(0, 0, w, h);

        const total = freeCount + paidCount;
        if (!total) {
          ctx.fillStyle = "#6b7280";
          ctx.font = "11px -apple-system,system-ui,sans-serif";
          ctx.fillText("暂无数据", 8, h / 2);
          ctx.restore();
          return;
        }

          // 让圆环稍微往左移一点，半径缩小一点，避免被卡片边缘切掉
       const cx = w / 2 - 10;
       const cy = h / 2;
       const r = Math.min(w, h) / 2 - 24;
       const innerR = r * 0.6;


        const startAngle = -Math.PI / 2;
        const freeAngle = (freeCount / total) * Math.PI * 2;
        const paidAngle = (paidCount / total) * Math.PI * 2;

        // free
        ctx.beginPath();
        ctx.arc(cx, cy, r, startAngle, startAngle + freeAngle);
        ctx.arc(
          cx,
          cy,
          innerR,
          startAngle + freeAngle,
          startAngle,
          true
        );
        ctx.closePath();
        ctx.fillStyle = "#60a5fa";
        ctx.fill();

        // paid
        if (paidCount) {
          ctx.beginPath();
          ctx.arc(
            cx,
            cy,
            r,
            startAngle + freeAngle,
            startAngle + freeAngle + paidAngle
          );
          ctx.arc(
            cx,
            cy,
            innerR,
            startAngle + freeAngle + paidAngle,
            startAngle + freeAngle,
            true
          );
          ctx.closePath();
          ctx.fillStyle = "#22c55e";
          ctx.fill();
        }

        // inner circle
        ctx.beginPath();
        ctx.arc(cx, cy, innerR, 0, Math.PI * 2);
        ctx.fillStyle = "rgba(15,23,42,1)";
        ctx.fill();

        ctx.fillStyle = "#e5e7eb";
        ctx.font = "11px -apple-system,system-ui,sans-serif";
        const text = `free ${freeCount}${
          paidCount ? ` / paid ${paidCount}` : ""
        }`;
        const tw = ctx.measureText(text).width;
        ctx.fillText(text, cx - tw / 2, cy + 4);

        ctx.restore();
      }

      function drawCharts(users) {
        // 最近 14 天注册趋势（基于当前 users 估算）
        const now = Date.now() / 1000;
        const oneDay = 24 * 3600;
        const days = [];
        for (let i = 13; i >= 0; i--) {
          const dayStart = Math.floor((now - i * oneDay) / oneDay) * oneDay;
          days.push({
            ts: dayStart,
            label: "",
            value: 0,
          });
        }

        users.forEach((u) => {
          const t = u.created_at || 0;
          if (!t) return;
          const dayIndex = Math.floor(
            (t - (now - 14 * oneDay)) / oneDay
          );
          const idx = days.length - 1 - (13 - dayIndex);
          // 简单匹配 —— 实际上只要在最近 14 天内就行
          for (let i = 0; i < days.length; i++) {
            const d0 = days[i].ts;
            const d1 = d0 + oneDay;
            if (t >= d0 && t < d1) {
              days[i].value += 1;
              break;
            }
          }
        });

        const ctxLine = chartRegCanvas.getContext("2d");
        chartRegCanvas.width = chartRegCanvas.clientWidth * devicePixelRatio;
        chartRegCanvas.height = chartRegCanvas.clientHeight * devicePixelRatio;
        const points = days.map((d) => ({
          value: d.value,
        }));
        drawLine(ctxLine, points, "#60a5fa");

        // 套餐分布（当前页）
        let free = 0;
        let paid = 0;
        users.forEach((u) => {
          const plan = (u.plan || "free").toLowerCase();
          if (plan === "free") free++;
          else paid++;
        });
        const ctxDonut = chartPlansCanvas.getContext("2d");
        chartPlansCanvas.width =
          chartPlansCanvas.clientWidth * devicePixelRatio;
        chartPlansCanvas.height =
          chartPlansCanvas.clientHeight * devicePixelRatio;
        drawDonut(ctxDonut, free, paid);
      }

      async function exportCsv() {
        if (!adminPassword) return;
        const params = new URLSearchParams();
        if (search) params.set("search", search);

        const resp = await fetch(
          `${API_BASE}/admin/users/export?` + params.toString(),
          {
            headers: { "x-admin-password": adminPassword },
          }
        );

        if (!resp.ok) {
          alert("导出失败：" + resp.status);
          return;
        }

        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "aurum_users.csv";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      // 事件绑定
      loginBtn.addEventListener("click", adminLogin);
      adminPwdInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") adminLogin();
      });
      logoutBtn.addEventListener("click", () => {
        adminPassword = "";
        dashView.style.display = "none";
        loginView.style.display = "block";
        adminPwdInput.value = "";
        usersTbody.innerHTML = "";
      });

      prevBtn.addEventListener("click", () => {
        if (page > 1) {
          page--;
          loadUsers();
        }
      });
      nextBtn.addEventListener("click", () => {
        if (page * pageSize < total) {
          page++;
          loadUsers();
        }
      });
      pageSizeSelect.addEventListener("change", () => {
        pageSize = parseInt(pageSizeSelect.value, 10) || 50;
        page = 1;
        loadUsers();
      });

      searchInput.addEventListener(
        "input",
        debounce(() => {
          search = searchInput.value.trim();
          page = 1;
          loadUsers();
        }, 400)
      );

      exportBtn.addEventListener("click", exportCsv);
    </script>
  </body>
</html>
