<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Aurum Task Desk 后台总览</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    :root {
      --bg: #020617;
      --card: #020617;
      --card-soft: #020617;
      --border-soft: rgba(148, 163, 184, 0.18);
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
      --accent: #fbbf24;
      --accent-strong: #f59e0b;
      --danger: #f97373;
      --muted: #6b7280;
      --blue-soft: #0b1220;
      --panel-radius: 22px;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text",
        system-ui, "Segoe UI", sans-serif;
      min-height: 100vh;
      background:
        radial-gradient(circle at top left, #111827 0%, #020617 45%, #000 100%);
      color: var(--text-main);
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 32px 16px 40px;
    }

    .shell {
      width: 100%;
      max-width: 1260px;
      border-radius: 28px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background:
        radial-gradient(circle at top left, rgba(15,23,42,0.9) 0%, #020617 50%),
        radial-gradient(circle at bottom right, rgba(15,23,42,0.8) 0%, #020617 55%);
      box-shadow:
        0 26px 80px rgba(0,0,0,0.8),
        0 0 0 1px rgba(15,23,42,0.8) inset;
      overflow: hidden;
      position: relative;
    }

    .shell-header {
      padding: 20px 28px 12px;
      border-bottom: 1px solid rgba(51,65,85,0.8);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .shell-header-left {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .logo-badge {
      width: 40px;
      height: 40px;
      border-radius: 16px;
      background:
        radial-gradient(circle at 10% 0%, #fef3c7 0%, #facc15 30%, #f59e0b 70%, #92400e 100%);
      box-shadow:
        0 12px 30px rgba(0,0,0,0.6),
        0 0 0 1px rgba(180, 83, 9, 0.45) inset;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #111827;
      font-weight: 800;
      font-size: 20px;
      letter-spacing: 0.02em;
    }
    .title-block h1 {
      font-size: 18px;
      letter-spacing: 0.03em;
      font-weight: 650;
    }
    .title-block p {
      font-size: 12px;
      color: var(--text-soft);
      margin-top: 2px;
    }

    .tag-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .tag-chip {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: #e5e7eb;
      background: rgba(15,23,42,0.8);
    }
    .tag-chip.gold {
      border-color: rgba(251, 191, 36, 0.7);
      color: #fbbf24;
      background: linear-gradient(
        135deg,
        rgba(251, 191, 36, 0.18),
        rgba(30, 64, 175, 0.2)
      );
    }
    .tag-chip.small {
      font-size: 9px;
      opacity: 0.8;
    }

    .shell-header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      padding: 7px 14px;
      font-size: 12px;
      color: var(--text-main);
      background: rgba(15,23,42,0.85);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.16s ease-out;
    }
    .btn:hover {
      border-color: rgba(148,163,184,0.9);
      background: rgba(30,64,175,0.85);
    }
    .btn-primary {
      border-color: rgba(251, 191, 36, 0.9);
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: #111827;
      font-weight: 600;
      box-shadow: 0 14px 35px rgba(0,0,0,0.7);
    }
    .btn-primary:hover {
      filter: brightness(1.03);
      transform: translateY(-0.5px);
    }
    .btn-danger {
      border-color: rgba(248, 113, 113, 0.7);
      color: #fecaca;
      background: linear-gradient(
        135deg,
        rgba(239,68,68,0.26),
        rgba(127,29,29,0.6)
      );
    }
    .btn-danger:hover {
      border-color: rgba(248,113,113,0.9);
    }

    .pill-text {
      font-size: 10px;
      color: var(--muted);
      letter-spacing: 0.16em;
      text-transform: uppercase;
    }

    /* layout */
    .shell-body {
      display: flex;
      padding: 18px 20px 22px;
      gap: 16px;
    }
    .side-panel {
      flex: 0 0 280px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .main-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .card {
      border-radius: var(--panel-radius);
      background: radial-gradient(circle at top, #020617 0%, #020617 48%, #020617 100%);
      border: 1px solid rgba(30, 64, 175, 0.55);
      box-shadow:
        0 18px 40px rgba(0,0,0,0.8),
        0 0 0 1px rgba(15,23,42,0.9) inset;
      padding: 14px 16px 12px;
      position: relative;
    }
    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: radial-gradient(circle at top left, rgba(251,191,36,0.12), transparent 60%);
      opacity: 0.9;
      pointer-events: none;
      mix-blend-mode: soft-light;
    }
    .card-inner {
      position: relative;
      z-index: 1;
    }

    .side-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .side-header h2 {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .stat-kpi {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
      color: var(--text-soft);
    }
    .stat-kpi strong {
      font-size: 24px;
      font-weight: 700;
      color: #e5e7eb;
      letter-spacing: 0.06em;
    }
    .stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      margin-top: 6px;
      color: var(--text-soft);
    }
    .stat-row span.value {
      color: #e5e7eb;
      font-weight: 500;
    }

    .small-caption {
      margin-top: 10px;
      font-size: 11px;
      color: var(--muted);
      line-height: 1.5;
    }

    .table-wrapper {
      margin-top: 6px;
      border-radius: 12px;
      border: 1px solid rgba(55,65,81,0.9);
      background: radial-gradient(circle at top, #020617 0%, #020617 50%, #020617 100%);
      max-height: 220px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .table-header {
      font-size: 11px;
      color: var(--muted);
      padding: 6px 8px;
      border-bottom: 1px solid rgba(55,65,81,0.9);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .table-header span {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
    }

    .table-scroll {
      flex: 1;
      overflow: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    th, td {
      padding: 5px 8px;
      border-bottom: 1px solid rgba(31,41,55,0.9);
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }
    th {
      position: sticky;
      top: 0;
      background: #020617;
      z-index: 1;
      font-weight: 500;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.14em;
    }
    td {
      color: #e5e7eb;
    }
    tr:nth-child(even) td {
      background: rgba(15,23,42,0.8);
    }

    .pill-plan {
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }
    .pill-plan.free {
      border-color: rgba(148,163,184,0.65);
      color: #e5e7eb;
    }
    .pill-plan.paid {
      border-color: rgba(251,191,36,0.9);
      background: rgba(251,191,36,0.16);
      color: #facc15;
    }

    .chart-row {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.3fr);
      gap: 12px;
    }
    .chart-container {
      margin-top: 8px;
      border-radius: 14px;
      border: 1px solid rgba(55,65,81,0.9);
      background: radial-gradient(circle at top, rgba(15,23,42,1) 0%, #020617 60%);
      padding: 8px 10px 10px;
    }
    .chart-title {
      font-size: 12px;
      margin-bottom: 4px;
      color: #e5e7eb;
    }
    .chart-sub {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    canvas {
      width: 100%;
      height: 160px;
      display: block;
    }

    .section-tabs {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
      margin-top: 2px;
    }
    .section-tab {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid transparent;
      color: var(--muted);
      cursor: pointer;
      background: transparent;
      transition: all 0.15s ease-out;
    }
    .section-tab.active {
      color: #fde68a;
      border-color: rgba(251,191,36,0.8);
      background: radial-gradient(circle at top, rgba(251,191,36,0.22), transparent 70%);
    }

    .error-text {
      font-size: 11px;
      margin-top: 6px;
      color: #fecaca;
    }
    .hint-text {
      font-size: 11px;
      margin-top: 4px;
      color: var(--muted);
    }

    /* 登录视图 */
    #login-view {
      min-height: 260px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 28px;
    }
    .login-card {
      width: 100%;
      max-width: 460px;
      border-radius: 26px;
      border: 1px solid rgba(148,163,184,0.4);
      background:
        radial-gradient(circle at top left, rgba(30,64,175,0.7) 0%, #020617 55%),
        radial-gradient(circle at bottom right, rgba(15,23,42,0.9) 0%, #020617 65%);
      box-shadow: 0 26px 70px rgba(0,0,0,0.9);
      padding: 22px 24px 18px;
      position: relative;
    }
    .login-card::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      border: 1px solid rgba(15,23,42,0.8);
      pointer-events: none;
    }
    .login-title {
      font-size: 18px;
      font-weight: 650;
      margin-bottom: 4px;
    }
    .login-sub {
      font-size: 12px;
      color: var(--text-soft);
      margin-bottom: 16px;
    }
    .field-label {
      font-size: 12px;
      margin-bottom: 4px;
      color: var(--text-soft);
    }
    .field-input {
      width: 100%;
      padding: 9px 11px;
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      font-size: 13px;
      outline: none;
      box-shadow: 0 0 0 1px rgba(15,23,42,1) inset;
    }
    .field-input:focus {
      border-color: rgba(251,191,36,0.9);
      box-shadow: 0 0 0 1px rgba(251,191,36,0.7) inset;
    }
    .login-btn-row {
      margin-top: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #dashboard-view {
      display: none;
    }

    @media (max-width: 960px) {
      .shell {
        border-radius: 0;
      }
      .shell-body {
        flex-direction: column;
      }
      .side-panel {
        flex-basis: auto;
      }
    }
  </style>
</head>
<body>
<div class="shell">
  <!-- 顶部标题 & 环境标签 -->
  <div class="shell-header">
    <div class="shell-header-left">
      <div class="logo-badge">A</div>
      <div>
        <div class="tag-row">
          <div class="tag-chip gold">AURUM ADMIN</div>
          <div class="tag-chip small">INTERNAL DESK</div>
        </div>
        <div class="title-block">
          <h1>Aurum Task Desk 后台总览</h1>
          <p>查看注册趋势、套餐分布、访问日志等数据，仅供内部使用。</p>
        </div>
      </div>
    </div>
    <div class="shell-header-right">
      <span class="pill-text">INTERNAL USE ONLY</span>
    </div>
  </div>

  <!-- 登录视图 -->
  <div id="login-view">
    <div class="login-card">
      <div class="tag-row" style="margin-bottom: 10px;">
        <div class="tag-chip gold">AURUM ADMIN</div>
        <div class="tag-chip small">CLOUDFLARE · D1 · WORKERS AI</div>
      </div>
      <div class="login-title">Aurum Task Desk 后台</div>
      <div class="login-sub">
        输入你的 <b>管理员密码</b> 登录，然后查看用户列表、注册趋势以及访问日志。
      </div>

      <label class="field-label" for="admin-password-input">Admin password</label>
      <input id="admin-password-input" class="field-input" type="password" placeholder="输入管理员密码…" />

      <div class="login-btn-row">
        <button id="login-btn" class="btn btn-primary">进入 Aurum Task Desk 后台</button>
        <span id="login-status" class="hint-text"></span>
      </div>

      <div class="small-caption" style="margin-top: 14px;">
        密码保存在 Cloudflare Worker 的 <code>ADMIN_PASSWORD</code> 环境变量中。<br>
        本页面只在你自己的后台使用，不要对外公开链接。
      </div>
    </div>
  </div>

  <!-- 仪表盘视图 -->
  <div id="dashboard-view">
    <div class="shell-body">
      <!-- 左侧侧栏 -->
      <div class="side-panel">
        <div class="card">
          <div class="card-inner">
            <div class="side-header">
              <h2>站点概览</h2>
              <button id="refresh-btn" class="btn btn-primary" style="padding-inline: 10px;">
                刷新数据
              </button>
            </div>
            <div class="stat-kpi">
              <div>总用户数</div>
              <strong id="total-users">-</strong>
              <div class="stat-row">
                <span>最近一位用户注册时间：</span>
                <span class="value" id="latest-user-time">-</span>
              </div>
              <div class="stat-row">
                <span>最近一位用户地区：</span>
                <span class="value" id="latest-user-country">-</span>
              </div>
              <div class="stat-row">
                <span>最近 7 天新增</span>
                <span class="value" id="recent-7d-users">-</span>
              </div>
              <div class="stat-row">
                <span>付费用户 / 免费用户</span>
                <span class="value" id="paid-free-ratio">-</span>
              </div>
            </div>

            <div class="small-caption">
              提示：所有数据来自 D1 数据库 <code>aurum_users</code>，每次刷新会重新统计。
            </div>

            <div style="margin-top: 10px;">
              <button id="logout-btn" class="btn btn-danger" style="width: 100%; justify-content: center;">
                登出后台
              </button>
            </div>
          </div>
        </div>

        <!-- 最近用户（精简版） -->
        <div class="card">
          <div class="card-inner">
            <div class="side-header">
              <h2>最近 5 个注册用户</h2>
            </div>
            <div class="table-wrapper" style="max-height: 210px;">
              <div class="table-header">
                <span>最近注册</span>
              </div>
              <div class="table-scroll">
                <table id="recent-users-table">
                  <thead>
                  <tr>
                    <th style="width: 26px;">#</th>
                    <th>Email</th>
                    <th style="width: 56px;">Plan</th>
                    <th style="width: 60px;">国家</th>
                  </tr>
                  </thead>
                  <tbody>
                  <!-- js 填充 -->
                  </tbody>
                </table>
              </div>
            </div>
            <div class="small-caption">
              按注册时间倒序，仅展示最近 5 个用户。
            </div>
          </div>
        </div>
      </div>

      <!-- 右侧主面板 -->
      <div class="main-panel">
        <!-- 顶部 KPI 卡片 & 图表 -->
        <div class="card">
          <div class="card-inner">
            <div class="section-tabs">
              <button class="section-tab active" data-section="users">用户概览</button>
              <button class="section-tab" data-section="logs">访问日志</button>
            </div>

            <!-- 用户概览区域 -->
            <div id="section-users">
              <div class="chart-row">
                <div class="chart-container">
                  <div class="chart-title">最近 14 天注册趋势</div>
                  <div class="chart-sub">按日期统计注册用户数，用于观察投放节奏。</div>
                  <canvas id="users-line-chart"></canvas>
                </div>
                <div class="chart-container">
                  <div class="chart-title">套餐分布（当前用户）</div>
                  <div class="chart-sub">免费 / 付费 用户数比例。</div>
                  <canvas id="plan-pie-chart"></canvas>
                </div>
              </div>

              <!-- 全量用户列表 -->
              <div style="margin-top: 10px;">
                <div class="table-wrapper" style="max-height: 260px;">
                  <div class="table-header">
                    <span>最近注册用户（最多 200 条）</span>
                  </div>
                  <div class="table-scroll">
                    <table id="all-users-table">
                      <thead>
                      <tr>
                        <th style="width: 34px;">ID</th>
                        <th>Email</th>
                        <th style="width: 60px;">Plan</th>
                        <th style="width: 110px;">IP</th>
                        <th style="width: 66px;">国家</th>
                        <th style="width: 90px;">来源</th>
                        <th style="width: 140px;">创建时间</th>
                      </tr>
                      </thead>
                      <tbody>
                      <!-- js 填充 -->
                      </tbody>
                    </table>
                  </div>
                </div>
                <div class="hint-text">
                  数据来源：<code>/admin/users</code> API，按创建时间倒序，最多 200 条。
                </div>
              </div>
            </div>

            <!-- 访问日志区域 -->
            <div id="section-logs" style="display:none;">
              <div class="chart-container">
                <div class="chart-title">最近访问日志（最多 200 条）</div>
                <div class="chart-sub">
                  显示每次请求的路径、方法、IP、国家与 User-Agent，用于排查异常流量。
                </div>
                <div class="table-wrapper" style="max-height: 330px; margin-top: 6px;">
                  <div class="table-scroll">
                    <table id="logs-table">
                      <thead>
                      <tr>
                        <th style="width:40px;">ID</th>
                        <th style="width:120px;">时间</th>
                        <th>Path</th>
                        <th style="width:55px;">Method</th>
                        <th style="width:110px;">IP</th>
                        <th style="width:70px;">国家</th>
                        <th>User-Agent</th>
                      </tr>
                      </thead>
                      <tbody>
                      <!-- js 填充 -->
                      </tbody>
                    </table>
                  </div>
                </div>
                <div class="hint-text">
                  数据来源：<code>/admin/logs</code> API。日志由 Worker 自动写入
                  <code>request_logs</code> 表。
                </div>
              </div>
            </div>

            <div id="global-error" class="error-text" style="display:none;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // ===== 根据你的 Worker 域名修改这里 =====
  const API_BASE = "https://aurum-task-worker.sophieinbg.workers.dev";
  // =======================================

  let adminPassword = "";
  let usersCache = [];

  const loginView = document.getElementById("login-view");
  const dashboardView = document.getElementById("dashboard-view");
  const loginBtn = document.getElementById("login-btn");
  const loginStatus = document.getElementById("login-status");
  const adminPwdInput = document.getElementById("admin-password-input");
  const refreshBtn = document.getElementById("refresh-btn");
  const logoutBtn = document.getElementById("logout-btn");
  const errorBox = document.getElementById("global-error");

  const sectionTabs = document.querySelectorAll(".section-tab");
  const sectionUsers = document.getElementById("section-users");
  const sectionLogs = document.getElementById("section-logs");

  const totalUsersEl = document.getElementById("total-users");
  const latestUserTimeEl = document.getElementById("latest-user-time");
  const latestUserCountryEl = document.getElementById("latest-user-country");
  const recent7El = document.getElementById("recent-7d-users");
  const ratioEl = document.getElementById("paid-free-ratio");

  const recentUsersTableBody = document.querySelector("#recent-users-table tbody");
  const allUsersTableBody = document.querySelector("#all-users-table tbody");
  const logsTableBody = document.querySelector("#logs-table tbody");

  let lineChartCtx, pieChartCtx;

  function formatTime(ts) {
    if (!ts) return "-";
    const d = new Date(ts * 1000);
    const y = d.getFullYear();
    const m = (d.getMonth() + 1).toString().padStart(2, "0");
    const day = d.getDate().toString().padStart(2, "0");
    const hh = d.getHours().toString().padStart(2, "0");
    const mm = d.getMinutes().toString().padStart(2, "0");
    const ss = d.getSeconds().toString().padStart(2, "0");
    return `${y}/${m}/${day} ${hh}:${mm}:${ss}`;
  }

  function setError(msg) {
    if (!msg) {
      errorBox.style.display = "none";
      errorBox.textContent = "";
      return;
    }
    errorBox.style.display = "block";
    errorBox.textContent = msg;
  }

  async function apiPost(path, body) {
    const res = await fetch(API_BASE + path, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(body || {})
    });
    return res;
  }

  async function apiGet(path) {
    const headers = {
      "Content-Type": "application/json",
      "x-admin-password": adminPassword
    };
    const res = await fetch(API_BASE + path, {
      method: "GET",
      headers
    });
    return res;
  }

  async function handleLogin() {
    const pwd = adminPwdInput.value.trim();
    if (!pwd) {
      loginStatus.textContent = "请输入管理员密码。";
      loginStatus.style.color = "#fecaca";
      return;
    }
    loginStatus.textContent = "正在验证密码…";
    loginStatus.style.color = "#9ca3af";

    try {
      const res = await apiPost("/admin/login", { password: pwd });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data.ok) {
        loginStatus.textContent = data.error || "密码验证失败。";
        loginStatus.style.color = "#fecaca";
        return;
      }
      adminPassword = pwd;
      localStorage.setItem("aurum_admin_pw", pwd);
      loginStatus.textContent = "登录成功，正在加载数据…";
      loginStatus.style.color = "#a7f3d0";

      loginView.style.display = "none";
      dashboardView.style.display = "block";

      await loadAllData();
    } catch (err) {
      loginStatus.textContent = "网络异常，请检查 Worker 是否在线。";
      loginStatus.style.color = "#fecaca";
    }
  }

  async function loadUsers() {
    const res = await apiGet("/admin/users");
    const data = await res.json().catch(() => ({}));
    if (!res.ok || !data.ok) {
      throw new Error(data.error || "加载用户列表失败");
    }
    usersCache = data.users || [];
    renderUsers(usersCache);
    return usersCache;
  }

  async function loadLogs() {
    const res = await apiGet("/admin/logs");
    const data = await res.json().catch(() => ({}));
    if (!res.ok || !data.ok) {
      throw new Error(data.error || "加载访问日志失败");
    }
    const logs = data.logs || [];
    renderLogs(logs);
    return logs;
  }

  async function loadAllData() {
    setError("");
    try {
      await loadUsers();
      await loadLogs();
    } catch (e) {
      setError(e.message || String(e));
    }
  }

  function renderUsers(users) {
    // KPI
    const total = users.length;
    totalUsersEl.textContent = total.toString();

    if (total > 0) {
      const latest = users[0];
      latestUserTimeEl.textContent = formatTime(latest.created_at);
      latestUserCountryEl.textContent = latest.country || "UNKNOWN";
    } else {
      latestUserTimeEl.textContent = "-";
      latestUserCountryEl.textContent = "-";
    }

    const nowSec = Math.floor(Date.now() / 1000);
    const sevenDaysAgo = nowSec - 7 * 24 * 3600;
    const last7 = users.filter(u => (u.created_at || 0) >= sevenDaysAgo).length;
    recent7El.textContent = last7.toString();

    let paid = 0;
    let free = 0;
    users.forEach(u => {
      if (u.plan && u.plan !== "free") paid++;
      else free++;
    });
    ratioEl.textContent = `${paid} / ${free}`;

    // 最近 5 个用户（侧栏）
    const recent5 = users.slice(0, 5);
    recentUsersTableBody.innerHTML = "";
    recent5.forEach((u, idx) => {
      const tr = document.createElement("tr");
      const planClass = u.plan && u.plan !== "free" ? "paid" : "free";
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td title="${u.email}">${u.email}</td>
        <td><span class="pill-plan ${planClass}">${(u.plan || "free").toUpperCase()}</span></td>
        <td>${u.country || "-"}</td>
      `;
      recentUsersTableBody.appendChild(tr);
    });

    // 全量用户表
    allUsersTableBody.innerHTML = "";
    users.forEach(u => {
      const planClass = u.plan && u.plan !== "free" ? "paid" : "free";
      const created = formatTime(u.created_at);
      const ip = u.ip || "-";
      const country = u.country || "-";
      const src = u.signup_source || "-";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${u.id}</td>
        <td title="${u.email}">${u.email}</td>
        <td><span class="pill-plan ${planClass}">${(u.plan || "free").toUpperCase()}</span></td>
        <td title="${ip}">${ip}</td>
        <td>${country}</td>
        <td title="${src}">${src}</td>
        <td>${created}</td>
      `;
      allUsersTableBody.appendChild(tr);
    });

    drawUsersLineChart(users);
    drawPlanPieChart(free, paid);
  }

  function drawUsersLineChart(users) {
    const canvas = document.getElementById("users-line-chart");
    const ctx = canvas.getContext("2d");
    const now = new Date();
    const days = [];
    const counts = [];

    // 生成最近 14 天日期（从旧到新）
    for (let i = 13; i >= 0; i--) {
      const d = new Date(now.getTime() - i * 24 * 3600 * 1000);
      const key = d.toISOString().slice(0, 10);
      days.push(key);
      counts.push(0);
    }

    const dayIndexMap = {};
    days.forEach((d, idx) => (dayIndexMap[d] = idx));

    users.forEach(u => {
      if (!u.created_at) return;
      const d = new Date(u.created_at * 1000);
      const key = d.toISOString().slice(0, 10);
      const idx = dayIndexMap[key];
      if (idx !== undefined) counts[idx] += 1;
    });

    const width = canvas.width = canvas.clientWidth * window.devicePixelRatio;
    const height = canvas.height = canvas.clientHeight * window.devicePixelRatio;
    ctx.clearRect(0, 0, width, height);

    const paddingLeft = 30;
    const paddingRight = 10;
    const paddingTop = 10;
    const paddingBottom = 20;

    const maxVal = Math.max(...counts, 1);
    const chartWidth = width - paddingLeft - paddingRight;
    const chartHeight = height - paddingTop - paddingBottom;
    const stepX = chartWidth / Math.max(days.length - 1, 1);

    ctx.strokeStyle = "rgba(55, 65, 81, 0.9)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(paddingLeft, paddingTop);
    ctx.lineTo(paddingLeft, paddingTop + chartHeight);
    ctx.lineTo(paddingLeft + chartWidth, paddingTop + chartHeight);
    ctx.stroke();

    ctx.beginPath();
    ctx.strokeStyle = "rgba(56, 189, 248, 0.9)";
    ctx.lineWidth = 2;

    counts.forEach((val, idx) => {
      const x = paddingLeft + stepX * idx;
      const y = paddingTop + chartHeight * (1 - val / maxVal);
      if (idx === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    });
    ctx.stroke();

    ctx.fillStyle = "rgba(56, 189, 248, 0.22)";
    counts.forEach((val, idx) => {
      const x = paddingLeft + stepX * idx;
      const y = paddingTop + chartHeight * (1 - val / maxVal);
      ctx.beginPath();
      ctx.arc(x, y, 4, 0, Math.PI * 2);
      ctx.fill();
    });

    ctx.fillStyle = "rgba(148,163,184,0.9)";
    ctx.font = `${10 * window.devicePixelRatio}px system-ui, -apple-system`;
    const labelStep = Math.max(1, Math.floor(days.length / 4));
    days.forEach((d, idx) => {
      if (idx % labelStep !== 0 && idx !== days.length - 1) return;
      const x = paddingLeft + stepX * idx;
      const y = paddingTop + chartHeight + 14 * window.devicePixelRatio;
      const text = d.slice(5);
      ctx.fillText(text, x - 10 * window.devicePixelRatio, y);
    });
  }

  function drawPlanPieChart(freeCount, paidCount) {
    const canvas = document.getElementById("plan-pie-chart");
    const ctx = canvas.getContext("2d");
    const width = canvas.width = canvas.clientWidth * window.devicePixelRatio;
    const height = canvas.height = canvas.clientHeight * window.devicePixelRatio;
    ctx.clearRect(0, 0, width, height);

    const total = freeCount + paidCount;
    if (total === 0) {
      ctx.fillStyle = "rgba(55,65,81,0.9)";
      ctx.beginPath();
      ctx.arc(width / 2, height / 2, Math.min(width, height) / 4, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = "rgba(156,163,175,0.9)";
      ctx.font = `${12 * window.devicePixelRatio}px system-ui`;
      ctx.fillText("暂无数据", width / 2 - 30 * window.devicePixelRatio, height / 2);
      return;
    }

    const centerX = width / 2;
    const centerY = height / 2;
    const radius = Math.min(width, height) / 3.2;
    let start = -Math.PI / 2;

    const freeAngle = (freeCount / total) * Math.PI * 2;
    const paidAngle = (paidCount / total) * Math.PI * 2;

    ctx.beginPath();
    ctx.moveTo(centerX, centerY);
    ctx.fillStyle = "rgba(59,130,246,0.9)";
    ctx.arc(centerX, centerY, radius, start, start + freeAngle);
    ctx.closePath();
    ctx.fill();

    start += freeAngle;
    ctx.beginPath();
    ctx.moveTo(centerX, centerY);
    ctx.fillStyle = "rgba(251,191,36,0.95)";
    ctx.arc(centerX, centerY, radius, start, start + paidAngle);
    ctx.closePath();
    ctx.fill();

    ctx.fillStyle = "#020617";
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius * 0.55, 0, Math.PI * 2);
    ctx.fill();

    ctx.fillStyle = "rgba(248,250,252,0.95)";
    ctx.font = `${14 * window.devicePixelRatio}px system-ui`;
    ctx.fillText(
      `${paidCount}/${freeCount}`,
      centerX - 26 * window.devicePixelRatio,
      centerY + 4 * window.devicePixelRatio
    );
  }

  function renderLogs(logs) {
    logsTableBody.innerHTML = "";
    logs.forEach(log => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${log.id}</td>
        <td>${formatTime(log.created_at)}</td>
        <td title="${log.path}">${log.path}</td>
        <td>${log.method}</td>
        <td title="${log.ip || ""}">${log.ip || "-"}</td>
        <td>${log.country || "-"}</td>
        <td title="${log.user_agent || ""}">${(log.user_agent || "").slice(0,80)}</td>
      `;
      logsTableBody.appendChild(tr);
    });
  }

  // 事件绑定
  loginBtn.addEventListener("click", handleLogin);
  adminPwdInput.addEventListener("keydown", e => {
    if (e.key === "Enter") handleLogin();
  });

  refreshBtn.addEventListener("click", () => {
    if (!adminPassword) return;
    loadAllData();
  });

  logoutBtn.addEventListener("click", () => {
    adminPassword = "";
    localStorage.removeItem("aurum_admin_pw");
    loginView.style.display = "flex";
    dashboardView.style.display = "none";
  });

  sectionTabs.forEach(tab => {
    tab.addEventListener("click", () => {
      sectionTabs.forEach(t => t.classList.remove("active"));
      tab.classList.add("active");
      const section = tab.getAttribute("data-section");
      if (section === "users") {
        sectionUsers.style.display = "";
        sectionLogs.style.display = "none";
      } else {
        sectionUsers.style.display = "none";
        sectionLogs.style.display = "";
      }
    });
  });

  // 尝试自动登录（本地保存过密码的话）
  window.addEventListener("load", async () => {
    const saved = localStorage.getItem("aurum_admin_pw") || "";
    if (!saved) return;
    adminPassword = saved;
    loginView.style.display = "none";
    dashboardView.style.display = "block";
    try {
      await loadAllData();
    } catch (e) {
      setError(e.message || String(e));
    }
  });
</script>
</body>
</html>
